---
import PageLayout from '@layouts/PageLayout.astro'
import PocketBase from 'pocketbase'

import config from '../../config'
import useSigns from '@admin/composables/useSigns';
import FaceZonesOverlay from '@admin/components/FaceZonesOverlay.vue';
import type { TCategory } from '@types';
import BodyZonesOverlay from '@admin/components/BodyZonesOverlay.vue';

export const prerender = false

export async function getStaticPaths() {
  const pb = new PocketBase(config.apiBaseUrl)
  const signs = await pb.collection('sign').getFullList()
  return signs.map(sign => ({
    params: { sign: sign.slug },
  }))
}

const { sign } = Astro.params

const pb = new PocketBase(config.apiBaseUrl)
const mainCategories = await pb.collection<TCategory.TRecord>('category').getFullList({
  fields: 'id, tag, slug',
  sort: 'tag',
  filter: 'Parent = null',
})

const { learningSourceOptions, verificationStatusOptions } = useSigns()

const record = await pb.collection('sign').getFirstListItem(`slug="${sign}"`, {
  expand: 'Category,ConfigurationRight,ConfigurationLeft,person_via_Sign',
})

// La personne associée est maintenant disponible via record.expand?.person_via_Sign[0]
const personRecord = record.expand?.person_via_Sign?.[0] || null

const hasConfiguration = record.expand?.ConfigurationRight && record.expand?.ConfigurationRight?.illustration
const hasLeftConfiguration = record.expand?.ConfigurationLeft && record.expand?.ConfigurationLeft?.illustration

const videoUrl =
  `${config.apiBaseUrl}/api/files/sign/${record.id}/${record.video}`

const configurationUrl = `${config.apiBaseUrl}/api/files/hand_configurations/${record.expand?.ConfigurationRight?.id}/${record.expand?.ConfigurationRight?.illustration}`
const configurationLeftUrl = `${config.apiBaseUrl}/api/files/hand_configurations/${record.expand?.ConfigurationLeft?.id}/${record.expand?.ConfigurationLeft?.illustration}`

// extract categories with parent category
const categories = mainCategories.map(mainCat => {
  return {
    ...mainCat,
    subcategories: (record.expand?.Category || []).filter((cat: TCategory.TRecord) => cat.Parent === mainCat.id) || [],
  }
}).filter(cat => cat.subcategories.length > 0)

const colors = {
  right: '#f4309865',
  left: '#00bafe74'
}


// Définition d'un level numérique
const level = ['a1', 'a2', 'b1', 'b2', 'c1'].indexOf(record.level) + 1
const verificationStatus =  verificationStatusOptions.find(option => option.value === record.verification_status)?.label || 'Non spécifié'
const learningSource = learningSourceOptions.find(option => option.value === record.learning_source)?.label || 'Non spécifié'

---

<PageLayout>
  <div>
    <div class="px-6 mb-4"> 
      <h1 class="text-5xl mb-8 font-display text-primary">{record.name}</h1>
      <p>
        {record.definition && <span class="italic">Déf. </span>}{record.definition}
      </p>
    </div>
    <div class="grid grid-cols-12 gap-4">
      <div class="card card-md col-span-12 md:col-span-7 shadow-sm">
        <div class="card-body">
          <video autoplay controls>
            <source src={videoUrl} type="video/mp4" />
          </video>
          <div class="grid grid-cols-2 gap-4 mt-4">
            <div>
              { categories.map(cat => (
                <div class="flex items-center gap-4 pb-2 mb-2">
                  <h2 class="flex-1 self-start">{ cat.tag }</h2>
                  <ul>
                    {
                      cat.subcategories.map((category: any) => (
                        <li class="py-1 flex justify-end">
                          <div class="badge badge-outline badge-primary hover:badge-ghost justify-end">
                            <a href={`/categories/${cat.slug}/${category.slug}`}>{category.tag}</a>
                          </div>
                        </li>
                      ))
                    }
                  </ul>
                </div>
              ))}
              {personRecord && (
                <div class="alert alert-info mt-4">
                  <span class="i-fa-solid-user text-lg"></span>
                  <span>Personne associée : <a href={`/persons/${personRecord.slug}`} class="link link-hover font-bold">{personRecord.name}</a></span>
                </div>
              )}
            </div>
            <div>
              <div class="flex items-center gap-4 mb-3">
                <h2 class="flex-1">Niveau</h2>
                <div class="flex gap-1">
                  {Array.from({ length: 5 }, (_, i) => (
                    <span class={`text-xl ${i < level ? 'text-primary' : 'text-base-300'}`}>★</span>
                  ))}
                </div>
                <span class="text-sm">({record.level.toUpperCase()})</span>
              </div>
              <div class="flex items-center gap-4">
                <h2 class="flex-1">Statut du signe</h2>
                <span class="badge badge-outline badge-primary hover:badge-ghost">
                  {verificationStatus}
                </span>
              </div>
              <div class="flex items-center gap-4 mt-3">
                <h2 class="flex-1">Source d'apprentissage</h2>
                <span class="badge badge-outline badge-primary hover:badge-ghost">
                  {learningSource}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-span-12 md:col-span-5">
        <div class={`card shadow-sm h-full`}>
          <div class={`card-body gap-6 grid grid-cols-2 ${hasLeftConfiguration ? 'md:grid-cols-4' : 'md:grid-cols-3'}`}>
            { hasLeftConfiguration && (
              <div class="flex flex-col items-center gap-3">
                <div class="text-info font-semibold">Main gauche</div>
                <div class="flex items-center justify-center h-40 w-full">
                  <img
                    src={configurationLeftUrl}
                    alt="Configuration Main Gauche"
                    class="max-h-36 w-auto object-contain rounded-lg shadow"
                  />
                </div>
                <div class="w-full border rounded-lg bg-base-200 py-4 px-3 text-sm text-gray-600 text-center">
                  Mouvement main gauche (bientôt disponible)
                </div>
              </div>
            )}
            { hasConfiguration && (
              <div class="flex flex-col items-center gap-3">
                <div class="text-primary font-semibold">Main droite</div>
                <div class="flex items-center justify-center h-40 w-full">
                  <img
                    src={configurationUrl}
                    alt="Configuration Main Droite"
                    class="max-h-36 w-auto object-contain rounded-lg shadow"
                  />
                </div>
                <div class="w-full border rounded-lg bg-base-200 py-4 px-3 text-sm text-gray-600 text-center">
                  Mouvement main droite (bientôt disponible)
                </div>
              </div>
            )}
            <div class="col-span-2 text-center">
              <h3 class="text-lg font-semibold mb-4">Emplacements</h3>
              <div class="flex justify-center">
                <FaceZonesOverlay
                  client:only
                  right={record.placement?.right}
                  left={record.placement?.left}
                  colorConfig={colors}
                  activeHand="right"
                  interactive={false}
                />
              </div>
              <div class="flex justify-center pl-5">
                <BodyZonesOverlay
                  client:only
                  right={record.placement?.right}
                  left={record.placement?.left}
                  colorConfig={colors}
                  activeHand="right"
                  interactive={false}
                />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</PageLayout>
