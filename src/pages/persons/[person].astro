---
import PageLayout from '@layouts/PageLayout.astro'
import PocketBase from 'pocketbase'
import config from '../../config'
import { marked } from 'marked'

export const prerender = false

export async function getStaticPaths() {
  const pb = new PocketBase(config.apiBaseUrl)
  const persons = await pb.collection('person').getFullList()
  return persons.map(person => ({
    params: { person: person.slug },
  }))
}

const { person } = Astro.params

const pb = new PocketBase(config.apiBaseUrl)
const record = await pb.collection('person').getFirstListItem(`slug="${person}"`, {
  fields: 'id, name, firstname, illustration, slug, description, deaf, birthdate, birthplace, deafFamily, family, organism, highlights, expand.Category.*, expand.Category.expand.Parent.*, expand.Sign.*, expand.Videos.*',
  expand: 'Category,Category.Parent,Sign,Videos',
})

const imageUrl = record.illustration 
  ? `${config.apiBaseUrl}/api/files/person/${record.id}/${record.illustration}`
  : null

const imageThumbUrl = record.illustration
  ? `${config.apiBaseUrl}/api/files/person/${record.id}/${record.illustration}?thumb=600x600`
  : null

// Render Markdown description to HTML (server-side)
const descriptionHtml = record.description ? marked.parse(String(record.description)) : ''

// Fonction pour construire l'URL complète d'une catégorie
const getCategoryUrl = (cat: any) => {
  if (cat.expand?.Parent) {
    return `/culture/${cat.expand.Parent.slug}/${cat.slug}`
  }
  return `/culture/${cat.slug}`
}

// Fonction pour extraire l'ID YouTube d'une URL
const getYouTubeId = (url: string) => {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/
  const match = url.match(regExp)
  return match && match[2].length === 11 ? match[2] : null
}
---

<PageLayout>
  <div class="max-w-5xl mx-auto">
    <!-- En-tête avec hero -->
    <div class="hero bg-base-200 rounded-box mb-8 place-items-start">
      <div class="hero-content flex-col lg:flex-row gap-8 py-12">
        {imageUrl && (
          <picture class="flex-shrink-0">
            <source srcset={imageThumbUrl} media="(max-width: 600px)" />
            <img 
              src={imageUrl} 
              alt={record.name}
              class="max-w-sm w-full rounded-lg shadow-2xl object-cover aspect-square"
            />
          </picture>
        )}
        <div class="flex-1">
          <h1 class={`text-5xl font-bold mb-4 ${record.deaf ? 'text-info' : ''}`}>
            {!record.organism && record.firstname ? `${record.firstname} ${record.name}` : record.name}
            {record.expand?.Sign && (
              <a
                href={`/signs/${record.expand.Sign.slug}`}
                class="btn btn-info hover:bg-gray-400 ml-2"
                aria-label={`Voir le signe ${record.expand.Sign.name}`}
              >
                <span class="i-ic-round-sign-language"></span>
              </a>
            )}
          </h1>

          {/* Infos rapides à droite de l'image */}
          <div class="space-y-3 mb-6">
            {(record.birthdate || record.birthplace) && (
              <div class="flex items-start gap-2">
                <span class="i-fa-solid-baby text-base"></span>
                <div class="text-sm">
                  <span class="font-semibold">{record.organism ? 'Crée le:' : 'Né(e) le:'}</span>
                  {record.birthdate && (
                    <span> {(() => {
                      const d = new Date(String(record.birthdate).replace(' ', 'T'))
                      const dd = String(d.getDate()).padStart(2, '0')
                      const mm = String(d.getMonth() + 1).padStart(2, '0')
                      const yyyy = d.getFullYear()
                      return `${dd}.${mm}.${yyyy}`
                    })()}</span>
                  )}
                  {record.birthplace && (
                    <br><span>{record.birthplace}</span>
                  )}
                </div>
              </div>
            )}

            {!record.organism && (typeof record.deafFamily !== 'undefined' || record.family) && (
              <div class="flex items-start gap-2">
                <span class="i-fa-solid-users text-base"></span>
                <div class="text-sm">
                  {typeof record.deafFamily !== 'undefined' && (
                    <div class="font-semibold">{record.deafFamily ? 'Famille sourde' : 'Famille entendante'}</div>
                  )}
                  {record.family && (
                    <div class="opacity-80">{record.family}</div>
                  )}
                </div>
              </div>
            )}
          </div>

          {record.expand?.Category && record.expand.Category.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-4">
              {record.expand.Category.map((cat: any) => (
                <a href={getCategoryUrl(cat)} class="badge badge-primary badge-lg hover:badge-primary-focus transition-colors">
                  {cat.tag}
                </a>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>

    <!-- Grille principale : biographie + infos détaillées -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Section biographie (1/3) -->
      {record.highlights && record.highlights.length > 0 && (
        <div class="card bg-base-100 shadow-xl lg:col-span-1">
          <div class="card-body">
            <h2 class="card-title text-2xl mb-4">
              <span class="i-fa-solid-scroll"></span>
              Timeline
            </h2>
            
            <div class="timeline timeline-vertical timeline-snap-icon timeline-compact">
              {record.highlights.map((highlight: any) => (
                <li>
                  <div class="timeline-middle">
                    <span class="i-fa-solid-circle text-primary"></span>
                  </div>
                  <div class="timeline-start mb-10">
                    <time class="font-bold text-[16px]">{highlight.title}</time>
                    <p class="mt-2 text-base-content/80">{highlight.description}</p>
                  </div>
                  <hr class="bg-primary" />
                </li>
              ))}
            </div>
          </div>
        </div>
      )}

      <!-- Carte infos détaillées (2/3) -->
      <div class="card bg-base-100 shadow-xl lg:col-span-2">
        <div class="card-body">
          <h2 class="card-title text-2xl mb-4">
            <span class="i-fa-solid-info-circle"></span>
            Présentation
          </h2>
          
          <div class="space-y-4">
            {record.description && (
              <div class="prose prose-sm md:prose-base max-w-none text-base-content prose-headings:text-base-content prose-strong:text-base-content prose-p:text-base-content/80 person-prose">
                <article set:html={descriptionHtml} />
              </div>
            )}
          </div>
        </div>
      </div>
    </div>

    <!-- Section vidéos -->
    {record.expand?.Videos && record.expand.Videos.length > 0 && (
      <div class="card bg-base-100 shadow-xl mt-8">
        <div class="card-body">
          <h2 class="card-title text-3xl mb-6">
            <span class="i-fa-solid-play"></span>
            Vidéos
          </h2>
          
          <div class="carousel carousel-center w-full gap-4 rounded-box bg-base-200 p-4" id="videos-carousel">
            {record.expand.Videos.map((video: any, index: number) => {
              const youtubeId = getYouTubeId(video.url)
              return youtubeId ? (
                <div class="carousel-item w-full sm:w-96 flex-shrink-0" data-carousel-index={index}>
                  <div class="w-full aspect-video">
                    <iframe
                      width="100%"
                      height="100%"
                      src={`https://www.youtube.com/embed/${youtubeId}`}
                      title={video.title}
                      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                      allowfullscreen
                      class="rounded-lg"
                    />
                  </div>
                </div>
              ) : null
            })}
          </div>
        </div>
      </div>
    )}
      </div>
    </div>
  </div>
</PageLayout>